<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
    <channel>
        <title>Posts on Higgsx Brain Dump</title>
        <link>http://redsec.blog/posts/</link>
        <description>Recent content in Posts on Higgsx Brain Dump</description>
        <generator>Hugo -- gohugo.io</generator>
        <language>en-us</language>
        <copyright>&lt;a href=&#34;https://creativecommons.org/licenses/by-nc/4.0/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;CC BY-NC 4.0&lt;/a&gt;</copyright>
        <lastBuildDate>Mon, 20 Sep 2021 00:00:00 +0000</lastBuildDate>
        <atom:link href="http://redsec.blog/posts/index.xml" rel="self" type="application/rss+xml" />
        
        <item>
            <title>Backdooring using AdminSDHolder</title>
            <link>http://redsec.blog/posts/2021/09/backdooring-using-adminsdholder/</link>
            <pubDate>Mon, 20 Sep 2021 00:00:00 +0000</pubDate>
            
            <guid>http://redsec.blog/posts/2021/09/backdooring-using-adminsdholder/</guid>
            <description>In a red team operation when we gain Domain Admin privileges, we want to make sure we will have access to the environment even though system administrators or blue teamers notice it. In Active Directory environment amount of TTPs (Techniques, Tactics, Procedures) for persistence is huge. One common way to persist is to use AdminSDHolder container, which is in System container
Every 60 minutes SDPropagator in AD, will overwrite Protected groups ACL with AdminSDHolder ACL.</description>
            <content type="html"><![CDATA[<p>In a red team operation when we gain Domain Admin privileges, we want to make sure we will have access to the environment even though system administrators or blue teamers notice it. In Active Directory environment amount of TTPs (Techniques, Tactics, Procedures) for persistence is huge. One common way to persist is to use <code>AdminSDHolder</code> container, which is in <code>System</code> container</p>
<p><img src="/images/Untitled.png" alt="Untitled"></p>
<p>Every 60 minutes SDPropagator in AD, will overwrite Protected groups ACL with <code>AdminSDHolder</code> ACL. In other words, if you change DACL of <code>Domain Admins</code> Group, it will be overwritten by SDProp every 1 hour.</p>
<p>Many folks will change DACL of Domain Admins but there is high chance that someone will notice it. In case we change DACL of AdminSDHolder, even though administrator notices and changes <code>DACL</code> of DA, in 60 minutes Domain Admins DACL will be changed and will give you more time to move laterally.</p>
<p><code>Note</code>: For the following demonstrations I am using <a href="https://www.zeropointsecurity.co.uk/red-team-ops/overview">ZeroPointSecurity</a> CRTO Lab.</p>
<p>First, Let&rsquo;s see what we can do if we have FullControl (same as <code>GenericAll</code>) over DA group.</p>
<p>Create new user: panda</p>
<p><img src="/images/Untitled%201.png" alt="Untitled"></p>
<p>Test if we really have that user via ActiveDirectory module, installed default on every Domain Controller</p>
<p><code>&gt; Get-ADUser Panda</code></p>
<p><img src="/images/Untitled%202.png" alt="Untitled"></p>
<p>and we want to give panda something powerful. Open <code>Domain Admins</code> group DACL or as everyone is familiar with: Permissions. We have DACL and SACL. DACL stands for: Discretionary Access Control List and SACL stands for: System Access Control List. <code>SACL</code> is for audit purposes but the blog post isn&rsquo;t about that.</p>
<p><img src="/images/Untitled%203.png" alt="Untitled"></p>
<p>ACL is a list or chain of ACEs. ACEs at the upper level takes precedence over ACEs below.</p>
<p>Click add to add our user panda to <code>ACL</code></p>
<p><img src="/images/Untitled%204.png" alt="Untitled"></p>
<p>And give full permission (Full Control) also  known as <code>GenericAll</code></p>
<p><img src="/images/Untitled%205.png" alt="Untitled"></p>
<p>and we see listed here</p>
<p><img src="/images/Untitled%206.png" alt="Untitled"></p>
<p>Now that panda has Full Access to this group we can add users to this group or change properties of DA group.</p>
<p><img src="/images/Untitled%207.png" alt="Untitled"></p>
<p>first, in order to make sure panda has full access to the group we can use powershell.</p>
<p><code>&gt; Get-ACL -Path &quot;AD:CN=Domain Admins,CN=Users,DC=dev,DC=cyberbotic,DC=io&quot; | select -ExpandProperty Access</code></p>
<p><img src="/images/Untitled%208.png" alt="Untitled"></p>
<p><img src="/images/Untitled%209.png" alt="Untitled"></p>
<p>now, execute powershell in a context of domain user: panda and try to add user to DA group</p>
<p><img src="/images/Untitled%2010.png" alt="Untitled"></p>
<p><img src="/images/Untitled%2011.png" alt="Untitled"></p>
<p><img src="/images/Untitled%2012.png" alt="Untitled"></p>
<p><img src="/images/Untitled%2014.png" alt="Untitled"></p>
<p>After Deletion</p>
<p><img src="/images/Untitled%2013.png" alt="Untitled"></p>
<p>Important Note: just because you have GenericAll on Domain Admins group, doesn&rsquo;t mean you can manipulate users enrolled in the group. So you can&rsquo;t reset passwords of users within this group and etc.</p>
<p>You can add your user temporarily and grant yourself DA privileges. But issue is that it isn&rsquo;t permanent because as we said: <code>AdminSDHolder</code>. Every 60 minutes, SDPropagator propagates AdminSDHolder&rsquo;s ACL into Protected Groups: <code>Domain Admin</code> <code>Print Operators</code> etc.</p>
<p><img src="/images/Untitled.png" alt="Untitled"></p>
<p>if you compare lets say DA group to adminsdholder group acls. they will be equal</p>
<p><img src="/images/Untitled%2015.png" alt="Untitled"></p>
<p>So in order to make smart move, you can add your new user to <code>AdminSDHolder</code> DACL and in 60 minutes you will be added to every protected groups such as <code>Domain Admins</code>, <code>Print Operators</code>, <code>Backup Operators</code> and etc.</p>
<p>Many sysadmin aren&rsquo;t aware of that feature, but are aware of membership of Domain Admins group. There is less chance of detection if the above mentioned container will be used to persistence.</p>
]]></content>
        </item>
        
        <item>
            <title>HTB Offshore Review</title>
            <link>http://redsec.blog/posts/2021/09/htb-offshore-review/</link>
            <pubDate>Mon, 20 Sep 2021 00:00:00 +0000</pubDate>
            
            <guid>http://redsec.blog/posts/2021/09/htb-offshore-review/</guid>
            <description>Introduction At the beginning, HackTheBox was platform known for just a single box exercises but it evolved a lot and become one of the best platform for honing your cyber security skills and tradecraft.
One of the best feature of this platform is its prolabs
 Dante Offshore RastaLabs Cybernetics APTLabs  Prolabs are huge labs composed of several domains and forests, spanned across different subnets and each one of them varies by difficulty and sizes.</description>
            <content type="html"><![CDATA[<h1 id="introduction">Introduction</h1>
<p><img src="/images/brucelee.png" alt="Example image"></p>
<p>At the beginning, HackTheBox was platform known for just a single box exercises but it evolved a lot and become one of the best platform for honing your cyber security skills and tradecraft.</p>
<p>One of the best feature of this platform is its prolabs</p>
<ul>
<li>Dante</li>
<li>Offshore</li>
<li>RastaLabs</li>
<li>Cybernetics</li>
<li>APTLabs</li>
</ul>
<p>Prolabs are huge labs composed of several domains and forests, spanned across different subnets and each one of them varies by difficulty and sizes.</p>
<h1 id="what-offshore-offers">What offshore offers</h1>
<p>HackTheBox offshore is  one of the prolab which is focused mainly on Active Directory exploitation and lateral movement and is rated as intermediate level difficulty and is good practice opportunity for those who has basic background in networking, active directory, coding or for those who simply completed OSCP certification exam and are eager to learn more.</p>
<p>This lab covers following areas:</p>
<ul>
<li>Lateral Movement between Domains/Forests</li>
<li>Active Directory attacks</li>
<li>Reverse Engineering</li>
<li>Local Privilege Escalation</li>
<li>A few CTF exercises</li>
<li>Web Application Attacks</li>
</ul>
<h1 id="prerequisite">Prerequisite</h1>
<p>This lab definitely requires some prerequisites such as:</p>
<ul>
<li>Basic knowledge and hands-on experience of Active Directory</li>
<li>Basic working experience with Linux</li>
<li>Basic reading/writing coding skills</li>
<li>Web Application security</li>
<li>Basics of Networking</li>
</ul>
<h3 id="active-directory">Active Directory</h3>
<p>This is maybe the most important thing you have to know to succeed in this lab, because it is about 70% Active Directory and without this prerequisite you will have utterly difficult times. Of course there are some people who accomplished without prior knowledge of AD, but it must be very hard and stressful and really doesn&rsquo;t worth it if you devote 24/7 to only this lab :)</p>
<p>So what to do beforehand? there are several options</p>
<ul>
<li>purchase online course on AD administration from let&rsquo;s say Udemy, Pluralsight, CBT nuggets etc.</li>
<li>Build your own AD lab on your laptop, PC, on your dedicated servers or use cloud providers such as Azure and AWS. I personally recommend AWS.</li>
</ul>
<p>Some training providers have capability to host labs on their platforms and you can practice there. For example CBT Nuggets have feature where when you are going through the course you can practice in lab provided. You are given windows machines and you can interact with them just through your browser, no additional hardware/software are necessary except simple web browser like Google Chrome, Edge etc.</p>
<p>If you ask me you should do both</p>
<ul>
<li>Build your own AD lab, create domains, forests and trusts between them, install MSSQL servers and etc&hellip;</li>
<li>And go through training providers' own lab and training courses</li>
</ul>
<p>You don&rsquo;t need to be AD guru to do offshore, just basics will do fine and rest can be learned along the practice in offshore. Well, still it isn&rsquo;t enough :)</p>
<p>knowledge of some AD is good but attacking is different story. AD has lots of attack vectors and some of them are still effective and you should know them.</p>
<p>what can you do to improve your skillset is attacking AD?</p>
<p>The best training course out there on attacking AD is this linked below</p>
<p><a href="https://www.pentesteracademy.com/activedirectorylab">https://www.pentesteracademy.com/activedirectorylab</a></p>
<p>PentesterAcademy&rsquo;s CRTP training course is BEST and very well organized. I will devote one review on CRTP course, but in short, it is worth to purchase and pass the exam before tackling offshore, you will thank me later :)</p>
<p>In short you will learn:</p>
<ul>
<li><code>DCSync</code> attack and why it works the way it works</li>
<li>DCShadow for persistence</li>
<li>Abusing ACLs</li>
<li>Abuse local service misconfigurations</li>
<li>Neat persistent tricks such as: <code>AdminSDHolder</code>, <code>SeEnableDelegationPrivilege</code> and so on.</li>
</ul>
<h3 id="coding-skills">Coding skills</h3>
<p>Well, this is not as required as AD but will be very beneficial to you, if you want to automate some tasks and read codes. There were several cases where programming experience helped me much. In short, you should have basic coding skills, especially in python and that&rsquo;s it.</p>
<h3 id="web-application-attacks">Web Application Attacks</h3>
<p>Offshore has lots of web applications where you exploit and gain code execution. You should know basics of web app hacking such as: <code>XSS</code>, <code>SQLi</code>, <code>XXE</code>, <code>SSRF</code> and so on. Nothing fancy just basics.</p>
<p>Where can you learn basics? <a href="https://portswigger.net/web-security">https://portswigger.net/web-security</a></p>
<h3 id="networking">Networking</h3>
<p>During your lab time you definitely have to pivot through different domains. Even domains aren&rsquo;t accessible directly and you have to chain multiple domains to get to the point you want. You will touch topics such as <code>SSH port forwardings(Remote, Local, Dynamic)</code>, <code>Chisel</code>, <code>socks proxies</code> and etc&hellip;</p>
<p>You should also have basic knowledge of networking such as IP addresses, subnets, default gateways, MACs, TCP/UDP, ICMP and etc..</p>
<p>You don&rsquo;t need to be <code>CCNA</code> certified but should have some basics. Even half of <code>Network+</code>is enough</p>
<h3 id="how-to-succeed">How to succeed?</h3>
<ul>
<li>It is time consuming. No easy wins. Almost everything is patched. make sure you have time, 2-3 hours per day</li>
<li>HackTheBox <a href="https://discord.com/invite/hackthebox">discord</a> server. You should use this. You will get stucked very often and you will need nudges along the ways and also will learn something by teaching others(If you&rsquo;re active on discord, people will contact you for nudges and that&rsquo;s awesome). Everyone is different and everyone has their own unique way of solving puzzles.</li>
<li>Patience, Patience and patience. You will get stucked many times. Be aware of that.</li>
</ul>
<h1 id="my-background-before-offshore">My background before offshore</h1>
<h3 id="1st-month-prior-to-purchasing-offshore">1st Month prior to purchasing offshore</h3>
<p>I didn&rsquo;t know anything about AD. Bought some training courses on Active Directory and Windows server administrations. Also I built my own lab on AWS and practiced there.</p>
<p>If you are interested which training courses I took</p>
<ul>
<li>
<p><a href="https://www.udemy.com/course/windows-server-2019-active-directory-and-group-policies-gpo/learn/lecture/16801412?start=0#overview">Windows Server 2019 AD and GPOs</a></p>
</li>
<li>
<p><a href="https://www.udemy.com/course/active-directory-group-policy-2012/learn/lecture/4213218?start=0#overview">AD Group Policies</a></p>
</li>
<li>
<p><a href="https://www.serveracademy.com/">Server Academy</a></p>
</li>
</ul>
<h3 id="2nd-month-prior-to-purchasing-offshore">2nd month prior to purchasing offshore</h3>
<p>Bought CRTP and passed exam at the end of the month.</p>
<h3 id="3rd-and-4th-month">3rd and 4th month</h3>
<p>Working on offshore. It took me 2 month. After 1 month I had compromised all domains, I mean, I had Domain Admins on all of the domains but I still had several flags left and 1-2 weeks took me to find those rest flags. On final weeks I was trying to use C2 framework: <code>Covenant</code> but I had severe issues with its stability and gave up.</p>
<p>Finally I collected all flags and obtained certification</p>
<p><img src="/images/cert.png" alt="Example image"></p>
]]></content>
        </item>
        
    </channel>
</rss>
